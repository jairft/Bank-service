<div class="transactional-password-container">
  <mat-card class="transactional-password-card">

    <!-- Voltar -->
    <div class="back-link" (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
    </div>

    <!-- Header -->
    <div class="transactional-password-header">
      <mat-icon class="logo-icon">lock</mat-icon>
      <h1>Senha Transacional</h1>
      <p>Crie ou altere sua senha de 4 dígitos para autorizar transações</p>
    </div>

    <!-- Formulário inicial -->
    <form *ngIf="showInitialForm" [formGroup]="transactionForm" (ngSubmit)="onSubmit()" class="transactional-password-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Senha</mat-label>
        <input matInput type="password" maxlength="4" formControlName="password" placeholder="Digite 4 dígitos">
        <mat-error *ngIf="password?.hasError('required')">Senha é obrigatória</mat-error>
        <mat-error *ngIf="password?.hasError('pattern')">Apenas números são permitidos</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Confirme a Senha</mat-label>
        <input matInput type="password" maxlength="4" formControlName="confirmPassword" placeholder="Repita a senha">
        <mat-error *ngIf="confirmPassword?.hasError('required')">Confirmação é obrigatória</mat-error>
        <mat-error *ngIf="transactionForm.hasError('passwordsMismatch')">As senhas não coincidem</mat-error>
      </mat-form-field>

      <app-error-message [message]="errorMessage" [show]="!!errorMessage"></app-error-message>
      <app-success-message [message]="successMessage" [show]="!!successMessage"></app-success-message>

      <button mat-raised-button type="submit" class="full-width action-button" [disabled]="transactionForm.invalid || isLoading">
        <span *ngIf="!isLoading">Salvar Senha</span>
        <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
      </button>
    </form>

    <!-- Tela informando que já tem senha -->
    <div *ngIf="status === 'ACTIVE' && !showUpdateForm" class="update-password-section">
      <p>Você já possui senha cadastrada. Deseja alterá-la?</p>
      <button mat-raised-button class="full-width action-button" (click)="showUpdate()">Alterar Senha</button>
      <div class="forgot-password-link" >
        <a (click)="onForgotPassword()" class="forgot-link">Esqueceu sua senha?</a>
      </div>
    </div>

    <!-- Formulário de atualização -->
    <form *ngIf="showUpdateForm" [formGroup]="updateForm" (ngSubmit)="onUpdate()" class="transactional-password-form">
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Senha Atual</mat-label>
        <input matInput type="password" maxlength="4" formControlName="currentPassword" placeholder="Digite a senha atual">
        <mat-error *ngIf="currentPassword?.hasError('required')">Senha atual é obrigatória</mat-error>
        <mat-error *ngIf="currentPassword?.hasError('pattern')">Apenas números são permitidos</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Nova Senha</mat-label>
        <input matInput type="password" maxlength="4" formControlName="newPassword" placeholder="Digite a nova senha">
        <mat-error *ngIf="newPassword?.hasError('required')">Nova senha é obrigatória</mat-error>
        <mat-error *ngIf="newPassword?.hasError('pattern')">Apenas números são permitidos</mat-error>
      </mat-form-field>

      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Confirme a Nova Senha</mat-label>
        <input matInput type="password" maxlength="4" formControlName="confirmPassword" placeholder="Repita a nova senha">
        <mat-error *ngIf="confirmNewPassword?.hasError('required')">Confirmação é obrigatória</mat-error>
        <mat-error *ngIf="updateForm.hasError('passwordsMismatch')">As senhas não coincidem</mat-error>
      </mat-form-field>

      <app-error-message [message]="errorMessage" [show]="!!errorMessage"></app-error-message>
      <app-success-message [message]="successMessage" [show]="!!successMessage"></app-success-message>

      <div class="button-group">
        <button mat-raised-button type="submit" class="full-width action-button" [disabled]="updateForm.invalid || isLoading">
          <span *ngIf="!isLoading">Atualizar Senha</span>
          <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
        </button>
        <button mat-button type="button" class="full-width" (click)="showUpdateForm=false; showInitialForm=false">Cancelar</button>
      </div>
    </form>

  </mat-card>
</div>
